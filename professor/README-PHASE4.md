# Phase 4: 온라인피드백 관리 ✅ 완성!

## 🎯 구현 완료

### ✅ **PDF.js v2.16.105** + **Fabric.js v5.3.0**
### ✅ **작성자별 색상 구분** + **음성 녹음**
### ✅ **텍스트 드래그 선택** + **페이지 마커**

---

## 📦 파일 구조

```
phase4-feedback/
├── README-PHASE4.md         ✨ 이 파일
├── index.html               (CDN 추가)
└── assets/
    ├── css/
    │   ├── style.css
    │   ├── guidance.css
    │   ├── meeting-v2.css
    │   └── feedback.css      ✨ NEW
    └── js/
        ├── mock-data.js
        ├── common.js
        ├── app.js            (feedback 초기화 추가)
        ├── dashboard.js
        ├── mock-data-extension.js
        ├── guidance.js
        ├── meeting-data-v2.js
        ├── meeting-v2.js
        ├── meeting-v2-part2.js
        ├── feedback-data.js      ✨ NEW (데이터)
        ├── feedback-list.js      ✨ NEW (목록)
        ├── feedback-viewer.js    ✨ NEW (뷰어)
        └── feedback-tools.js     ✨ NEW (도구+코멘트)
```

---

## 🎨 주요 기능

### **1. 제출물 목록**
```
┌─────┬──────────┬──────────────┬─────┐
│학생 │파일      │표절검사      │상태 │
├─────┼──────────┼──────────────┼─────┤
│김철수│연구계획서│📋 12% / 🤖 5%│대기│
│이영희│1장.pdf   │📋 8% / 🤖 3% │완료│
└─────┴──────────┴──────────────┴─────┘
```

- ✅ 표절률 통합 표시 (카피킬러 / GPT킬러)
- ✅ 색상 구분 (빨강/노랑/회색)
- ✅ 클릭 → 피드백 뷰어 열기

---

### **2. 3단 레이아웃 (제출 이력 최소화)**
```
┌──┬──────────────────────┬────────┐
│제│  PDF 뷰어 + 주석     │ 코멘트 │
│출│                      │        │
│이│  ┌─ 툴바 ────────┐  │ 💬     │
│력│  │🖍📝💬🧹🔍➖➕│  │        │
││  └───────────────┘  │        │
│●│                      │ 📍     │
│v│  [PDF 렌더링 영역]   │        │
│1│  • 하이라이트        │        │
│ │  • 판서              │        │
│○│  • 코멘트 ①②        │        │
│v│                      │        │
│0│                      │        │
└──┴──────────────────────┴────────┘
 200px     flex-1         350px
```

---

### **3. PDF 주석 도구**

#### **🖍 하이라이트 (형광펜)**
```javascript
색상: rgba(255, 255, 0, 0.4)  // 노란색
두께: 15px
사용: 마우스 드래그
```

#### **📝 판서 (Drawing)**
```javascript
색상: rgba(220, 38, 38, 0.9)  // 빨간색
두께: 2px
사용: 마우스 드래그
```

#### **💬 코멘트 마커**
```javascript
방법 1: 사각형 드래그 (빈 영역)
방법 2: 텍스트 선택 (PDF 본문) ✨

→ 자동으로 번호 마커 생성 (①②③)
→ 코멘트 입력 영역 표시
```

#### **🧹 지우개**
```javascript
크기: 20x20px
대상: 하이라이트, 판서만
코멘트는 삭제 불가
```

---

### **4. 작성자별 색상 구분** ✨

```javascript
박교수 (주지도):
  하이라이트: 노란색
  판서: 빨간색
  말풍선: 베이지색 + 빨간 테두리

이철수 (공동지도):
  하이라이트: 주황색
  판서: 파란색
  말풍선: 연한 파랑 + 파란 테두리
```

**말풍선 예시:**
```
┌────────────────────────────┐
│ 📝 박교수 (주지도)         │
│ ┃ 이 부분 수정 필요        │ ← 베이지 배경
│ └─ 2025-11-20 10:00        │
│                            │
│ 📝 이철수 (공동지도)       │
│ ┃ 참고문헌 추가            │ ← 파랑 배경
│ └─ 2025-11-20 14:30        │
└────────────────────────────┘
```

---

### **5. 텍스트 드래그 선택** ✨

```
PDF 본문:
┌─────────────────────────┐
│ 연구 방법론에 대해      │ ← 텍스트 드래그
│ 더 자세한 설명이        │
│ 필요합니다.             │
└─────────────────────────┘
  ↑
 ① 마커 자동 생성

→ 여러 줄 선택 시 자동으로 그룹화
→ 코멘트 입력 창 표시
```

---

### **6. 페이지 마커** ✨

```
┌────────────────────────────┐
│ 📍 페이지 코멘트           │
├────────────────────────────┤
│ 💬 1페이지 - 코멘트 ①②    │
│                            │
│ 🎨 9페이지에 판서/         │
│    하이라이트가 있습니다   │
│             [이동하기 →]   │ ← 클릭 시 9페이지로
│                            │
│ 💬 15페이지 - 코멘트 ③     │
└────────────────────────────┘
```

---

### **7. 음성 녹음** ✨

```
[🎤] 버튼 클릭
    ↓
MediaRecorder API 시작
    ↓
최대 60초 녹음
    ↓
[🛑] 클릭 or 자동 중지
    ↓
audioBlob → base64 변환
    ↓
코멘트에 추가
    ↓
<audio controls> 재생
```

---

### **8. 중첩 영역 처리** ✨

**문제:**
```
교수A: 1~5줄 하이라이트 (노란색)
교수B: 3~7줄 하이라이트 (주황색)

중첩: 3~5줄 (노란+주황 = 진한 주황)
```

**해결:**
1. **반투명 처리**: 중첩 시 더 진하게 표시
2. **호버 효과**: 마우스 오버 시 해당 교수의 주석만 강조
3. **색상 구분**: 작성자별 다른 색상

---

### **9. 동시 편집 정책** ✨

**낙관적 잠금 (Optimistic Locking)**

```
교수A: 코멘트 추가 (v1 → v2)
    ↓
교수B: 하이라이트 추가 (v1 기준)
    ↓
교수B: [저장] 시도
    ↓
버전 충돌 감지
    ↓
┌──────────────────────────┐
│ ⚠️ 충돌 감지             │
│ 이철수 교수님이 수정했습니다 │
│ (버전 v2)                │
└──────────────────────────┘
```

---

## 🔄 전체 워크플로우

### **1. 제출물 목록 → 피드백 화면**
```
온라인피드백 메뉴 클릭
    ↓
제출물 목록 표시 (테이블)
    ↓
김철수 - 연구계획서.pdf 클릭
    ↓
피드백 모달 열림 (전체 화면)
    ↓
PDF 로드 + 기존 주석 로드
```

### **2. 하이라이트 그리기**
```
[🖍] 버튼 클릭
    ↓
Fabric.js isDrawingMode = true
    ↓
마우스 드래그
    ↓
노란색 path 생성 (15px)
    ↓
annotations[페이지].push()
    ↓
저장 완료
```

### **3. 텍스트 선택 → 코멘트**
```
[선택] 도구 활성화
    ↓
PDF 텍스트 드래그
    ↓
window.getSelection()
    ↓
여러 줄 → 각각 Rect 생성
    ↓
Group으로 묶기
    ↓
마커 번호 생성 (①)
    ↓
코멘트 입력 영역 표시
```

### **4. 음성 메모 추가**
```
코멘트 카드에서 [🎤] 클릭
    ↓
navigator.mediaDevices.getUserMedia()
    ↓
MediaRecorder 녹음 시작
    ↓
[🛑] 클릭 or 60초
    ↓
audioBlob → base64
    ↓
comment.audio 저장
    ↓
<audio controls> 표시
```

### **5. 페이지 마커 클릭**
```
"9페이지에 판서가 있습니다" 클릭
    ↓
goToPage(9) 호출
    ↓
PDF 9페이지 렌더링
    ↓
주석 로드
    ↓
카드 하이라이트 (노란색)
```

---

## 📊 데이터 구조

```javascript
{
  // 사용자 정보
  users: {
    'P001': {
      id: 'P001',
      name: '박교수',
      role: 'main',
      colors: {
        highlight: 'rgba(255,255,0,0.4)',
        drawing: 'rgba(220,38,38,0.9)'
      }
    }
  },
  
  // 제출물
  feedbackRequests: [
    {
      id: 'fb-001',
      studentName: '김철수',
      file: '연구계획서.pdf',
      copykillerScore: '12%',
      gptkillerScore: '5%',
      // ...
    }
  ],
  
  // 피드백 데이터
  feedbackData: {
    'fb-001': {
      version: 1,
      lastModified: '2025-11-20 10:30',
      lastModifiedBy: 'P001',
      
      generalFeedbackThread: [
        {
          authorId: 'P001',
          authorName: '박교수',
          text: '전반적으로 좋습니다',
          audio: null,
          // ...
        }
      ],
      
      annotations: {
        '1': [  // 1페이지
          {
            type: 'path',
            customType: 'highlight',
            authorId: 'P001',
            stroke: 'rgba(255,255,0,0.4)',
            // ...
          },
          {
            type: 'rect',
            customType: 'comment',
            authorId: 'P001',
            comments: [
              {
                authorId: 'P001',
                text: '수정 필요',
                audio: 'data:audio/webm;base64,...',
                // ...
              }
            ]
          }
        ]
      }
    }
  }
}
```

---

## 🎨 라이브러리

| 라이브러리 | 버전 | 용도 | 라이선스 |
|-----------|------|------|---------|
| **PDF.js** | v2.16.105 | PDF 렌더링, 텍스트 레이어 | Apache 2.0 ✅ |
| **Fabric.js** | v5.3.0 | 캔버스 드로잉, 주석 관리 | MIT ✅ |
| **Font Awesome** | v6.4.0 | 아이콘 | Free License ✅ |

---

## ✅ 구현 체크리스트

### **필수 기능**
- [x] 제출물 목록 (표절률 통합)
- [x] 3단 레이아웃 (제출 이력 최소화)
- [x] PDF.js 뷰어
- [x] Fabric.js 캔버스
- [x] 페이지 네비게이션
- [x] 확대/축소 (자동 대응)

### **주석 도구**
- [x] 하이라이트 (노란색, 15px)
- [x] 판서 (빨간색, 2px)
- [x] 코멘트 마커 (사각형 드래그)
- [x] 코멘트 마커 (텍스트 드래그) ✨
- [x] 지우개 (20x20px)
- [x] 작성자별 색상 구분 ✨

### **코멘트 시스템**
- [x] 코멘트 스레드 (말풍선)
- [x] 전체 피드백
- [x] 음성 녹음 (MediaRecorder) ✨
- [x] 자주 쓰는 코멘트
- [x] 페이지 마커 ✨
- [x] 작성자 표시 (주지도/공동지도) ✨
- [x] 파일 첨부 (UI만)
- [x] 코멘트 연결 (데이터만)

### **부가 기능**
- [x] 버전 관리 (UI)
- [x] 동시 편집 경고 ✨
- [x] 표절/GPT 검사 (수치만)

---

## 🚀 테스트 가이드

### **1. 제출물 목록**
```
1. 온라인피드백 메뉴 클릭
2. ✅ 제출물 목록 테이블 표시
3. ✅ 표절률 색상 (빨강/노랑/회색)
4. 김철수 - 연구계획서.pdf 클릭
5. ✅ 피드백 모달 열림
```

### **2. 하이라이트 그리기**
```
1. [🖍] 버튼 클릭
2. PDF에서 마우스 드래그
3. ✅ 노란색 하이라이트 생성
4. [선택] 도구로 전환
5. ✅ 하이라이트 선택/이동 가능
```

### **3. 텍스트 선택 코멘트**
```
1. [선택] 도구 활성화
2. PDF 텍스트 드래그 선택
3. ✅ 자동으로 사각형 영역 생성
4. ✅ 마커 번호 (①) 표시
5. ✅ 오른쪽 코멘트 카드 추가
```

### **4. 음성 녹음**
```
1. 코멘트 카드에서 [🎤] 클릭
2. ✅ 마이크 권한 요청
3. 녹음 진행 (버튼 빨간색)
4. [🛑] 클릭
5. ✅ 말풍선에 audio 플레이어 표시
```

### **5. 페이지 마커**
```
1. 2페이지로 이동
2. [📝] 판서 도구로 그리기
3. 1페이지로 이동
4. ✅ 오른쪽 패널에 "2페이지에 판서가 있습니다" 표시
5. [이동하기 →] 클릭
6. ✅ 2페이지로 이동
```

### **6. 확대/축소**
```
1. [➕] 확대 클릭
2. ✅ PDF 확대
3. ✅ 주석도 자동 확대
4. ✅ 마커 위치도 자동 조정
5. [➖] 축소 클릭
6. ✅ 모든 요소 자동 축소
```

---

## 🎓 실제 구현 시 추가 사항

### **1. Zoom API 연동**
```javascript
// 녹화본 조회 API
GET /meetings/{meetingId}/recordings

// 음성 파일 업로드
POST /api/feedback/audio
Body: { audioData: base64, commentId: string }
```

### **2. PDF 업로드**
```javascript
// 학생이 제출한 PDF
POST /api/submissions
Body: FormData (file: PDF)

// S3 or 서버 저장
URL: https://storage.example.com/submissions/fb-001.pdf
```

### **3. 실시간 동기화 (선택)**
```javascript
// WebSocket
ws://server.com/feedback/{feedbackId}

// 이벤트
- annotation:added
- comment:added
- version:updated
```

---

## 💡 주요 개선 효과

| 개선 항목 | 효과 |
|----------|------|
| **작성자별 색상** | 누가 남긴 코멘트인지 직관적으로 파악 |
| **텍스트 드래그** | 정확한 영역 지정 (한 글자 단위) |
| **페이지 마커** | 긴 논문에서 코멘트 페이지 빠르게 이동 |
| **음성 녹음** | 복잡한 설명을 음성으로 전달 |
| **동시 편집 경고** | 충돌 방지 및 버전 관리 |

---

## 🆚 Phase 비교

| 항목 | Phase 1-3 | Phase 4 |
|------|-----------|---------|
| PDF 뷰어 | ❌ | ✅ PDF.js |
| 주석 도구 | ❌ | ✅ Fabric.js |
| 텍스트 선택 | ❌ | ✅ 드래그 선택 |
| 음성 녹음 | ❌ | ✅ MediaRecorder |
| 작성자 구분 | ❌ | ✅ 색상+이름 |
| 페이지 마커 | ❌ | ✅ 자동 생성 |

---

## 📌 주의사항

1. **PDF 파일 크기**: 대용량 PDF는 로딩 시간이 길 수 있음
2. **브라우저 호환성**: Chrome, Edge 권장 (Safari는 일부 기능 제한)
3. **음성 녹음**: HTTPS 환경에서만 작동 (마이크 권한)
4. **메모리**: 페이지 수가 많은 PDF는 메모리 사용량 증가

---

## 🎉 Phase 4 완료!

✅ **PDF.js** - PDF 렌더링  
✅ **Fabric.js** - 캔버스 주석  
✅ **작성자별 색상** - 직관적 구분  
✅ **텍스트 드래그** - 정확한 영역  
✅ **음성 녹음** - 음성 피드백  
✅ **페이지 마커** - 빠른 이동  
✅ **동시 편집 경고** - 충돌 방지  

**테스트 후 피드백 부탁드립니다!** 🚀
