# 단계 관리 기능 V2 구현 완료

## 구현 일자
2025-12-08

## 변경 개요
방안 3 (검색 필터 방식)을 적용하여 단계 관리 기능을 개선했습니다.

## 주요 변경사항

### 1. 통합 현황 탭 제거
- 2개 탭만 유지: 교수 배정, 단계 관리
- 통합 현황은 대시보드에서 제공
- 제목 수정: "교수 배정, 단계 관리, 통합 현황을 관리합니다" → "교수 배정 및 단계 관리를 수행합니다"

### 2. 논문 심사 단계 필수 선택 기능

#### 검색 필터 구조 변경
```
1. 논문 심사 단계 * (필수) ← 새로 추가
   - 석사 표준 과정
   - 박사 표준 과정

2. 학년도 (선택)
3. 학기 (선택)
4. 학기차 (선택) ← 새로 추가
5. 학과/전공 (선택)
6. 학번 (선택)
7. 이름 (선택)
8. 현재 단계 (선택) ← 선택된 심사 단계의 단계만 표시
```

#### 동작 방식
- **초기 상태**: 논문 심사 단계 미선택 시
  - 다른 모든 검색 필터 비활성화
  - 테이블에 안내 메시지 표시
  - 검색/초기화 버튼 비활성화

- **심사 단계 선택 시**:
  - 모든 검색 필터 활성화
  - 해당 심사 단계의 학생만 자동 필터링
  - 현재 단계 드롭다운에 선택된 심사 단계의 단계명만 표시
  - 검색/초기화 버튼 활성화

### 3. 테이블 컬럼 수정

#### 이전 구조
```
[체크박스] 학번 학과 성명 학위과정 학년 단계템플릿 현재단계 진행상태 관리
```

#### 변경된 구조
```
[체크박스] 학년도 학기차 학과 학번 성명 학위과정 적용논문심사단계 현재단계 진행상태 관리
```

#### 주요 변경
- **추가**: 학년도, 학기차 컬럼
- **변경**: "단계 템플릿" → "적용 논문 심사 단계"
- **제거**: 학년 컬럼 (학년도/학기차로 대체)

### 4. 일괄 처리 버튼 개선

#### 이전 구조
```
[일괄 단계 부여] [다음 단계 이관]
```

#### 변경된 구조
```
[일괄 단계 부여] [이전 단계 이관] [다음 단계 이관]
```

### 5. 이전 단계 이관 기능

#### 주요 기능
- 선택한 학생들을 이전 단계로 되돌리기
- 1단계 학생은 자동으로 제외
- 이관 가능한 학생 수 자동 계산 및 표시
- 확인 모달에 경고 메시지 표시

#### 검증 로직
```javascript
// 1단계가 아닌 학생만 이전 단계 이관 가능
const eligibleStudents = studentIds.filter(studentId => {
    const stageAssignment = mockStudentStageAssignments.find(s => s.studentId === studentId);
    return stageAssignment && stageAssignment.currentStageOrder > 1;
});
```

### 6. 검색 기능 개선

#### 심사 단계 기반 필터링
```javascript
// 선택된 심사 단계의 학생만 필터링
let filtered = mockStudentStageAssignments.filter(item => {
    if (item.thesisStageId !== selectedStageId) return false;
    // 추가 필터링 조건...
});
```

#### 추가된 검색 조건
- 학년도
- 학기
- 학기차

## 구현된 함수 목록

### 새로 추가된 함수
1. **getStageNamesByStageId(stageId)**: 특정 심사 단계의 단계 이름 목록 반환
2. **onThesisStageChange()**: 논문 심사 단계 변경 이벤트 핸들러
3. **bulkMoveToPrevStage()**: 이전 단계 일괄 이관
4. **closeBulkPrevStageModal()**: 이전 단계 이관 모달 닫기
5. **confirmBulkPrevStage()**: 이전 단계 이관 확인

### 수정된 함수
1. **renderStageManagementContent()**:
   - 선택된 심사 단계 기반 데이터 필터링
   - 심사 단계 미선택 시 안내 메시지 표시
   - 테이블 컬럼 구조 변경

2. **searchStageManagement()**:
   - 선택된 심사 단계 검증 추가
   - 학년도, 학기, 학기차 필터 추가
   - 심사 단계 기반 필터링

3. **resetStageSearch()**:
   - 학년도, 학기, 학기차 필드 초기화 추가

4. **updateStageSelectionButtons()**:
   - 이전 단계 이관 버튼(bulk-prev-btn) 제어 추가

## 전역 변수 추가

```javascript
window.selectedThesisStageId // 현재 선택된 논문 심사 단계 ID
window.eligibleStudentsForPrev // 이전 단계 이관 가능한 학생 ID 배열
```

## UI/UX 개선사항

### 1. 명확한 가이던스
- 논문 심사 단계 필수 선택 (빨간색 * 표시)
- 심사 단계 미선택 시 안내 메시지 표시
- 검색 필터 비활성화로 선택 순서 강제

### 2. 직관적인 버튼 배치
```
[일괄 단계 부여]  [← 이전 단계]  [다음 단계 →]
   빨간색            주황색         초록색
```

### 3. 데이터 무결성 보장
- 동일한 심사 단계의 학생만 일괄 처리 가능
- 드롭다운에 해당 심사 단계의 단계만 표시
- 실수로 다른 심사 단계 학생 섞이는 것 방지

## 문제 해결

### 기존 문제
1. **일괄 단계 부여 혼란**: 서로 다른 심사 단계(석사 5단계, 박사 7단계)의 학생 혼재
2. **드롭다운 혼란**: 어떤 단계 목록을 표시해야 할지 모호
3. **데이터 무결성**: 잘못된 단계 부여 가능성

### 해결 방법
1. **필수 필터**: 논문 심사 단계를 먼저 선택하도록 강제
2. **자동 필터링**: 선택된 심사 단계의 학생만 표시
3. **동적 드롭다운**: 선택된 심사 단계의 단계만 표시
4. **검증 로직**: 심사 단계 미선택 시 검색/일괄처리 불가

## 수정된 파일

1. **admin/admin_views.js** (Lines 2174-2356)
   - 통합 현황 탭 제거
   - 제목 및 설명 수정

2. **admin/admin_main.js** (Lines 3605-4393)
   - renderStageManagementContent() 함수 전면 수정
   - 헬퍼 함수 추가 (getStageNamesByStageId, onThesisStageChange)
   - 검색 함수 수정 (searchStageManagement, resetStageSearch)
   - 선택 버튼 제어 함수 수정 (updateStageSelectionButtons)
   - 이전 단계 이관 함수 추가 (bulkMoveToPrevStage, confirmBulkPrevStage, closeBulkPrevStageModal)

## 테스트 시나리오

### 1. 기본 동작 테스트
1. 단계 관리 탭 클릭
2. 논문 심사 단계 미선택 → 안내 메시지 확인
3. "석사 표준 과정" 선택 → 석사 학생만 표시 확인
4. "박사 표준 과정" 선택 → 박사 학생만 표시 확인

### 2. 검색 기능 테스트
1. 논문 심사 단계 선택
2. 학년도 필터 적용 → 필터링 확인
3. 학기차 필터 적용 → 필터링 확인
4. 현재 단계 필터 → 해당 심사 단계의 단계만 표시 확인

### 3. 일괄 처리 테스트
1. 석사 학생 여러 명 선택
2. 일괄 단계 부여 → 석사 단계(1-5)만 드롭다운에 표시 확인
3. 박사로 변경 → 박사 학생 여러 명 선택
4. 일괄 단계 부여 → 박사 단계(1-7)만 드롭다운에 표시 확인

### 4. 이전 단계 이관 테스트
1. 1단계 학생 선택 → "이관 불가" 메시지 확인
2. 2단계 이상 학생 선택 → 이전 단계 이관 성공 확인
3. 1단계와 2단계 혼합 선택 → 1단계 제외하고 이관 확인

## 기술적 특징

### 1. 상태 관리
- 전역 변수를 통한 선택된 심사 단계 추적
- 필터 데이터와 원본 데이터 분리

### 2. 조건부 렌더링
```javascript
${!selectedStageId ? `안내 메시지` : `테이블 표시`}
```

### 3. 동적 필터링
- 심사 단계 변경 시 자동 재렌더링
- 검색 조건과 심사 단계 조건 동시 적용

### 4. 사용자 경험
- 명확한 시각적 피드백 (disabled 상태)
- 단계별 가이던스 제공
- 에러 방지를 위한 검증

## 완료 확인

- [x] 통합 현황 탭 제거
- [x] 검색 필터에 '논문 심사 단계' 필수 선택 추가
- [x] 테이블 컬럼 수정 (학년도/학기차 추가)
- [x] 일괄 단계 부여 로직 수정 (선택된 심사 단계 기준)
- [x] 이전 단계 이관 기능 추가
- [x] 심사 단계 선택 시 필터링 및 검증 로직

## 다음 단계 (향후 개선)

1. **백엔드 연동**: API 호출로 Mock 데이터 대체
2. **권한 관리**: 단계 변경 권한 체크
3. **로그 기록**: 단계 변경 이력 추적
4. **알림 기능**: 단계 이관 시 교수/학생에게 알림
5. **대시보드 통합**: 통합 현황 대시보드 구현
